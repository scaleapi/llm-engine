# POC Dockerfile for vLLM with startup metrics instrumentation
# syntax=docker/dockerfile:1

# Use production vLLM image as base (includes working vllm_server.py for 0.11.1rc7)
FROM 692474966980.dkr.ecr.us-west-2.amazonaws.com/vllm:v0.11.1rc7-5

# Install OTel dependencies and bc for timing calculations
RUN apt-get update && apt-get install -y bc && rm -rf /var/lib/apt/lists/* \
    && pip install --no-cache-dir \
    opentelemetry-api~=1.27.0 \
    opentelemetry-sdk~=1.27.0 \
    opentelemetry-exporter-otlp~=1.27.0

# Move s5cmd to PATH (base image has it in /workspace)
RUN mv /workspace/s5cmd /usr/local/bin/s5cmd || true

WORKDIR /workspace

# Copy the instrumented server and telemetry module
COPY startup_telemetry.py /workspace/startup_telemetry.py
COPY vllm_server_instrumented.py /workspace/vllm_server_instrumented.py
COPY entrypoint.sh /workspace/entrypoint.sh
RUN chmod +x /workspace/entrypoint.sh

# Override entrypoint from parent image
ENTRYPOINT ["/workspace/entrypoint.sh"]
