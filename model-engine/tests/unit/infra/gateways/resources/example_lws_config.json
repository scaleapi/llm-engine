{
    "apiVersion": "leaderworkerset.x-k8s.io/v1",
    "kind": "LeaderWorkerSet",
    "metadata": {
      "creationTimestamp": "2000-01-01T01:38:14Z",
      "generation": 1,
      "labels": {
        "created_by": "userid000000",
        "endpoint_id": "end_abcdefg",
        "endpoint_name": "endpoint_name",
        "env": "training",
        "managed-by": "model-engine",
        "owner": "userid000000",
        "product": "testing",
        "tags.datadoghq.com/env": "training",
        "tags.datadoghq.com/service": "endpoint_name",
        "tags.datadoghq.com/version": "05fb96620692a205e52d33980eff475d6a52748a",
        "team": "infra",
        "use_scale_launch_endpoint_network_policy": "true",
        "user_id": "userid000000"
      },
      "managedFields": [
        {
          "apiVersion": "leaderworkerset.x-k8s.io/v1",
          "fieldsType": "FieldsV1",
          "fieldsV1": {
            "f:metadata": {
              "f:labels": {
                ".": {},
                "f:created_by": {},
                "f:endpoint_id": {},
                "f:endpoint_name": {},
                "f:env": {},
                "f:managed-by": {},
                "f:owner": {},
                "f:product": {},
                "f:tags.datadoghq.com/env": {},
                "f:tags.datadoghq.com/service": {},
                "f:tags.datadoghq.com/version": {},
                "f:team": {},
                "f:use_scale_launch_endpoint_network_policy": {},
                "f:user_id": {}
              }
            },
            "f:spec": {
              ".": {},
              "f:leaderWorkerTemplate": {
                ".": {},
                "f:leaderTemplate": {
                  ".": {},
                  "f:metadata": {
                    ".": {},
                    "f:annotations": {
                      ".": {},
                      "f:ad.datadoghq.com/main.logs": {},
                      "f:kubernetes.io/change-cause": {}
                    },
                    "f:labels": {
                      ".": {},
                      "f:app": {},
                      "f:created_by": {},
                      "f:endpoint_id": {},
                      "f:endpoint_name": {},
                      "f:env": {},
                      "f:managed-by": {},
                      "f:owner": {},
                      "f:product": {},
                      "f:sidecar.istio.io/inject": {},
                      "f:tags.datadoghq.com/env": {},
                      "f:tags.datadoghq.com/service": {},
                      "f:tags.datadoghq.com/version": {},
                      "f:team": {},
                      "f:use_scale_launch_endpoint_network_policy": {},
                      "f:user_id": {},
                      "f:version": {}
                    }
                  },
                  "f:spec": {
                    ".": {},
                    "f:affinity": {
                      ".": {},
                      "f:podAffinity": {
                        ".": {},
                        "f:preferredDuringSchedulingIgnoredDuringExecution": {}
                      }
                    },
                    "f:containers": {},
                    "f:nodeSelector": {},
                    "f:priorityClassName": {},
                    "f:serviceAccount": {},
                    "f:terminationGracePeriodSeconds": {},
                    "f:tolerations": {},
                    "f:volumes": {}
                  }
                },
                "f:restartPolicy": {},
                "f:size": {},
                "f:workerTemplate": {
                  ".": {},
                  "f:metadata": {
                    ".": {},
                    "f:annotations": {
                      ".": {},
                      "f:ad.datadoghq.com/main.logs": {},
                      "f:kubernetes.io/change-cause": {}
                    },
                    "f:labels": {
                      ".": {},
                      "f:app": {},
                      "f:created_by": {},
                      "f:endpoint_id": {},
                      "f:endpoint_name": {},
                      "f:env": {},
                      "f:managed-by": {},
                      "f:owner": {},
                      "f:product": {},
                      "f:sidecar.istio.io/inject": {},
                      "f:tags.datadoghq.com/env": {},
                      "f:tags.datadoghq.com/service": {},
                      "f:tags.datadoghq.com/version": {},
                      "f:team": {},
                      "f:use_scale_launch_endpoint_network_policy": {},
                      "f:user_id": {},
                      "f:version": {}
                    }
                  },
                  "f:spec": {
                    ".": {},
                    "f:affinity": {
                      ".": {},
                      "f:podAffinity": {
                        ".": {},
                        "f:preferredDuringSchedulingIgnoredDuringExecution": {}
                      }
                    },
                    "f:containers": {},
                    "f:nodeSelector": {},
                    "f:priorityClassName": {},
                    "f:serviceAccount": {},
                    "f:terminationGracePeriodSeconds": {},
                    "f:tolerations": {},
                    "f:volumes": {}
                  }
                }
              },
              "f:replicas": {},
              "f:startupPolicy": {}
            }
          },
          "manager": "OpenAPI-Generator",
          "operation": "Update",
          "time": "2000-01-01T01:38:14Z"
        },
        {
          "apiVersion": "leaderworkerset.x-k8s.io/v1",
          "fieldsType": "FieldsV1",
          "fieldsV1": {
            "f:status": {
              ".": {},
              "f:conditions": {},
              "f:hpaPodSelector": {}
            }
          },
          "manager": "manager",
          "operation": "Update",
          "subresource": "status",
          "time": "2000-01-01T01:38:14Z"
        }
      ],
      "name": "launch-endpoint-id-end-abcdefg",
      "namespace": "scale-deploy",
      "resourceVersion": "2289583184",
      "uid": "1d66ad78-3148-41b3-83fd-fb71d7656fb1"
    },
    "spec": {
      "leaderWorkerTemplate": {
        "leaderTemplate": {
          "metadata": {
            "annotations": {
              "ad.datadoghq.com/main.logs": "[{\"service\": \"endpoint_name\", \"source\": \"python\"}]",
              "kubernetes.io/change-cause": "Deployment at 2000-01-01 01:38:13.814158 UTC. Using deployment constructed from model bundle ID bun_cqi4v12d6mt002nap720, model bundle name endpoint_name, endpoint ID end_abcdefg"
            },
            "labels": {
              "app": "launch-endpoint-id-end-abcdefg",
              "created_by": "userid000000",
              "endpoint_id": "end_abcdefg",
              "endpoint_name": "endpoint_name",
              "env": "training",
              "managed-by": "model-engine",
              "owner": "userid000000",
              "product": "testing",
              "sidecar.istio.io/inject": "false",
              "tags.datadoghq.com/env": "training",
              "tags.datadoghq.com/service": "endpoint_name",
              "tags.datadoghq.com/version": "05fb96620692a205e52d33980eff475d6a52748a",
              "team": "infra",
              "use_scale_launch_endpoint_network_policy": "true",
              "user_id": "userid000000",
              "version": "v1"
            }
          },
          "spec": {
            "affinity": {
              "podAffinity": {
                "preferredDuringSchedulingIgnoredDuringExecution": [
                  {
                    "podAffinityTerm": {
                      "labelSelector": {
                        "matchExpressions": [
                          {
                            "key": "app",
                            "operator": "In",
                            "values": [
                              "launch-endpoint-id-end-abcdefg"
                            ]
                          }
                        ]
                      },
                      "topologyKey": "kubernetes.io/hostname"
                    },
                    "weight": 1
                  },
                  {
                    "podAffinityTerm": {
                      "labelSelector": {
                        "matchExpressions": [
                          {
                            "key": "3d45a96760a60018eb4a9d874e919aef",
                            "operator": "In",
                            "values": [
                              "True"
                            ]
                          }
                        ]
                      },
                      "topologyKey": "kubernetes.io/hostname"
                    },
                    "weight": 100
                  }
                ]
              }
            },
            "containers": [
              {
                "command": [
                  "/usr/bin/dumb-init",
                  "--",
                  "ddtrace-run",
                  "python",
                  "-m",
                  "model_engine_server.inference.forwarding.http_forwarder",
                  "--config",
                  "/workspace/model-engine/model_engine_server/inference/configs/service--http_forwarder.yaml",
                  "--port",
                  "5000",
                  "--num-workers",
                  "2",
                  "--set",
                  "forwarder.sync.predict_route=/predict",
                  "--set",
                  "forwarder.stream.predict_route=/stream",
                  "--set",
                  "forwarder.sync.healthcheck_route=/health",
                  "--set",
                  "forwarder.stream.healthcheck_route=/health"
                ],
                "env": [
                  {
                    "name": "DD_TRACE_ENABLED",
                    "value": "True"
                  },
                  {
                    "name": "DD_REMOTE_CONFIGURATION_ENABLED",
                    "value": "false"
                  },
                  {
                    "name": "DD_SERVICE",
                    "value": "endpoint_name"
                  },
                  {
                    "name": "DD_ENV",
                    "value": "training"
                  },
                  {
                    "name": "DD_VERSION",
                    "value": "05fb96620692a205e52d33980eff475d6a52748a"
                  },
                  {
                    "name": "DD_AGENT_HOST",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "status.hostIP"
                      }
                    }
                  },
                  {
                    "name": "AWS_PROFILE",
                    "value": "aws-profile"
                  },
                  {
                    "name": "AWS_CONFIG_FILE",
                    "value": "/opt/.aws/config"
                  },
                  {
                    "name": "RESULTS_S3_BUCKET",
                    "value": "bucket"
                  },
                  {
                    "name": "BASE_PATH",
                    "value": "/workspace"
                  },
                  {
                    "name": "ML_INFRA_SERVICES_CONFIG_PATH",
                    "value": "/workspace/model-engine-internal/resources/configs/infra_config_training.yaml"
                  }
                ],
                "image": "000000000000.dkr.ecr.us-west-2.amazonaws.com/llm-engine:tag",
                "imagePullPolicy": "IfNotPresent",
                "name": "http-forwarder",
                "ports": [
                  {
                    "containerPort": 5000,
                    "name": "http",
                    "protocol": "TCP"
                  }
                ],
                "readinessProbe": {
                  "httpGet": {
                    "path": "/readyz",
                    "port": 5000
                  },
                  "initialDelaySeconds": 10,
                  "periodSeconds": 5,
                  "timeoutSeconds": 5
                },
                "resources": {
                  "limits": {
                    "cpu": "1",
                    "ephemeral-storage": "1G",
                    "memory": "2Gi"
                  },
                  "requests": {
                    "cpu": "1",
                    "ephemeral-storage": "100M",
                    "memory": "100M"
                  }
                },
                "volumeMounts": [
                  {
                    "mountPath": "/opt/.aws/config",
                    "name": "config-volume",
                    "subPath": "config"
                  },
                  {
                    "mountPath": "/workspace/user_config",
                    "name": "user-config",
                    "subPath": "raw_data"
                  },
                  {
                    "mountPath": "/workspace/endpoint_config",
                    "name": "endpoint-config",
                    "subPath": "raw_data"
                  }
                ]
              },
              {
                "command": [
                  "/bin/bash",
                  "-c",
                  "./s5cmd --numworkers 512 cp --concurrency 10 --include '*.model' --include '*.json' --include '*.safetensors' --exclude 'optimizer*' s3://bucket/tag/userid000000/model_weights/* model_files;/workspace/init_ray.sh leader --ray_cluster_size=$RAY_CLUSTER_SIZE --own_address=$K8S_OWN_POD_NAME.$K8S_LWS_NAME.$K8S_OWN_NAMESPACE.svc.cluster.local;python -m vllm_server --model model_files --tensor-parallel-size 1 --port 5005 --disable-log-requests--enforce-eager"
                ],
                "env": [
                  {
                    "name": "VLLM_HOST_IP",
                    "value": "$(K8S_LEADER_NAME).$(K8S_LWS_NAME).$(K8S_OWN_NAMESPACE).svc.cluster.local"
                  },
                  {
                    "name": "NCCL_SOCKET_IFNAME",
                    "value": "eth0"
                  },
                  {
                    "name": "GLOO_SOCKET_IFNAME",
                    "value": "eth0"
                  },
                  {
                    "name": "NCCL_DEBUG",
                    "value": "INFO"
                  },
                  {
                    "name": "VLLM_LOGGING_LEVEL",
                    "value": "INFO"
                  },
                  {
                    "name": "AWS_PROFILE",
                    "value": "aws-profile"
                  },
                  {
                    "name": "AWS_CONFIG_FILE",
                    "value": "/opt/.aws/config"
                  },
                  {
                    "name": "K8S_OWN_POD_NAME",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "metadata.name"
                      }
                    }
                  },
                  {
                    "name": "K8S_OWN_NAMESPACE",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "metadata.namespace"
                      }
                    }
                  },
                  {
                    "name": "K8S_LWS_NAME",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "metadata.labels['leaderworkerset.sigs.k8s.io/name']"
                      }
                    }
                  },
                  {
                    "name": "K8S_LWS_LEADER_NAME",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "metadata.labels['leaderworkerset.sigs.k8s.io/leader-name']"
                      }
                    }
                  },
                  {
                    "name": "K8S_LWS_CLUSTER_SIZE",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "metadata.annotations['leaderworkerset.sigs.k8s.io/size']"
                      }
                    }
                  },
                  {
                    "name": "DD_TRACE_ENABLED",
                    "value": "true"
                  },
                  {
                    "name": "DD_SERVICE",
                    "value": "endpoint_name"
                  },
                  {
                    "name": "DD_ENV",
                    "value": "training"
                  },
                  {
                    "name": "DD_VERSION",
                    "value": "05fb96620692a205e52d33980eff475d6a52748a"
                  },
                  {
                    "name": "DD_AGENT_HOST",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "status.hostIP"
                      }
                    }
                  }
                ],
                "image": "000000000000.dkr.ecr.us-west-2.amazonaws.com/vllm:0.5.3.post1",
                "imagePullPolicy": "IfNotPresent",
                "name": "lws_leader",
                "ports": [
                  {
                    "containerPort": 5005,
                    "name": "http",
                    "protocol": "TCP"
                  }
                ],
                "readinessProbe": {
                  "httpGet": {
                    "path": "/health",
                    "port": 5005
                  },
                  "initialDelaySeconds": 10,
                  "periodSeconds": 5,
                  "timeoutSeconds": 5
                },
                "resources": {
                  "limits": {
                    "cpu": "10",
                    "ephemeral-storage": "94Gi",
                    "memory": "40Gi",
                    "nvidia.com/gpu": "1"
                  },
                  "requests": {
                    "cpu": "10",
                    "ephemeral-storage": "94Gi",
                    "memory": "40Gi",
                    "nvidia.com/gpu": "1"
                  }
                },
                "volumeMounts": [
                  {
                    "mountPath": "/opt/.aws/config",
                    "name": "config-volume",
                    "subPath": "config"
                  },
                  {
                    "mountPath": "/dev/shm",
                    "name": "dshm"
                  },
                  {
                    "mountPath": "/app/user_config",
                    "name": "user-config",
                    "subPath": "raw_data"
                  },
                  {
                    "mountPath": "/app/endpoint_config",
                    "name": "endpoint-config",
                    "subPath": "raw_data"
                  }
                ]
              }
            ],
            "nodeSelector": {
              "k8s.amazonaws.com/accelerator": "nvidia-hopper-h100",
              "node-lifecycle": "normal"
            },
            "priorityClassName": "model-engine-high-priority",
            "serviceAccount": "aws-profile",
            "terminationGracePeriodSeconds": 600,
            "tolerations": [
              {
                "effect": "NoSchedule",
                "key": "nvidia.com/gpu",
                "operator": "Exists"
              }
            ],
            "volumes": [
              {
                "configMap": {
                  "name": "aws-profile-config"
                },
                "name": "config-volume"
              },
              {
                "configMap": {
                  "name": "launch-endpoint-id-end-abcdefg"
                },
                "name": "user-config"
              },
              {
                "configMap": {
                  "name": "launch-endpoint-id-end-abcdefg-endpoint-config"
                },
                "name": "endpoint-config"
              },
              {
                "emptyDir": {
                  "medium": "Memory"
                },
                "name": "dshm"
              }
            ]
          }
        },
        "restartPolicy": "RecreateGroupOnPodRestart",
        "size": 2,
        "workerTemplate": {
          "metadata": {
            "annotations": {
              "ad.datadoghq.com/main.logs": "[{\"service\": \"endpoint_name\", \"source\": \"python\"}]",
              "kubernetes.io/change-cause": "Deployment at 2000-01-01 01:38:13.814158 UTC. Using deployment constructed from model bundle ID bun_cqi4v12d6mt002nap720, model bundle name endpoint_name, endpoint ID end_abcdefg"
            },
            "labels": {
              "app": "launch-endpoint-id-end-abcdefg",
              "created_by": "userid000000",
              "endpoint_id": "end_abcdefg",
              "endpoint_name": "endpoint_name",
              "env": "training",
              "managed-by": "model-engine",
              "owner": "userid000000",
              "product": "testing",
              "sidecar.istio.io/inject": "false",
              "tags.datadoghq.com/env": "training",
              "tags.datadoghq.com/service": "endpoint_name",
              "tags.datadoghq.com/version": "05fb96620692a205e52d33980eff475d6a52748a",
              "team": "infra",
              "use_scale_launch_endpoint_network_policy": "true",
              "user_id": "userid000000",
              "version": "v1"
            }
          },
          "spec": {
            "affinity": {
              "podAffinity": {
                "preferredDuringSchedulingIgnoredDuringExecution": [
                  {
                    "podAffinityTerm": {
                      "labelSelector": {
                        "matchExpressions": [
                          {
                            "key": "app",
                            "operator": "In",
                            "values": [
                              "launch-endpoint-id-end-abcdefg"
                            ]
                          }
                        ]
                      },
                      "topologyKey": "kubernetes.io/hostname"
                    },
                    "weight": 1
                  },
                  {
                    "podAffinityTerm": {
                      "labelSelector": {
                        "matchExpressions": [
                          {
                            "key": "3d45a96760a60018eb4a9d874e919aef",
                            "operator": "In",
                            "values": [
                              "True"
                            ]
                          }
                        ]
                      },
                      "topologyKey": "kubernetes.io/hostname"
                    },
                    "weight": 100
                  }
                ]
              }
            },
            "containers": [
              {
                "command": [
                  "/bin/bash",
                  "-c",
                  "./s5cmd --numworkers 512 cp --concurrency 10 --include '*.model' --include '*.json' --include '*.safetensors' --exclude 'optimizer*' s3://bucket/key/userid000000/model_weights/* model_files;/workspace/init_ray.sh worker --ray_cluster_size=$RAY_CLUSTER_SIZE --ray_address=$K8S_LEADER_NAME.$K8S_LWS_NAME.$K8S_OWN_NAMESPACE.svc.cluster.local --own_address=$K8S_OWN_POD_NAME.$K8S_LWS_NAME.$K8S_OWN_NAMESPACE.svc.cluster.local"
                ],
                "env": [
                  {
                    "name": "VLLM_HOST_IP",
                    "value": "$(K8S_LEADER_NAME).$(K8S_LWS_NAME).$(K8S_OWN_NAMESPACE).svc.cluster.local"
                  },
                  {
                    "name": "NCCL_SOCKET_IFNAME",
                    "value": "eth0"
                  },
                  {
                    "name": "GLOO_SOCKET_IFNAME",
                    "value": "eth0"
                  },
                  {
                    "name": "NCCL_DEBUG",
                    "value": "INFO"
                  },
                  {
                    "name": "VLLM_LOGGING_LEVEL",
                    "value": "INFO"
                  },
                  {
                    "name": "AWS_PROFILE",
                    "value": "aws-profile"
                  },
                  {
                    "name": "AWS_CONFIG_FILE",
                    "value": "/opt/.aws/config"
                  },
                  {
                    "name": "K8S_OWN_POD_NAME",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "metadata.name"
                      }
                    }
                  },
                  {
                    "name": "K8S_OWN_NAMESPACE",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "metadata.namespace"
                      }
                    }
                  },
                  {
                    "name": "K8S_LWS_NAME",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "metadata.labels['leaderworkerset.sigs.k8s.io/name']"
                      }
                    }
                  },
                  {
                    "name": "K8S_LWS_LEADER_NAME",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "metadata.labels['leaderworkerset.sigs.k8s.io/leader-name']"
                      }
                    }
                  },
                  {
                    "name": "K8S_LWS_CLUSTER_SIZE",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "metadata.annotations['leaderworkerset.sigs.k8s.io/size']"
                      }
                    }
                  },
                  {
                    "name": "DD_TRACE_ENABLED",
                    "value": "true"
                  },
                  {
                    "name": "DD_SERVICE",
                    "value": "endpoint_name"
                  },
                  {
                    "name": "DD_ENV",
                    "value": "training"
                  },
                  {
                    "name": "DD_VERSION",
                    "value": "05fb96620692a205e52d33980eff475d6a52748a"
                  },
                  {
                    "name": "DD_AGENT_HOST",
                    "valueFrom": {
                      "fieldRef": {
                        "fieldPath": "status.hostIP"
                      }
                    }
                  }
                ],
                "image": "000000000000.dkr.ecr.us-west-2.amazonaws.com/vllm:0.5.3.post1",
                "imagePullPolicy": "IfNotPresent",
                "name": "lws_worker",
                "ports": [
                  {
                    "containerPort": 5005,
                    "name": "http",
                    "protocol": "TCP"
                  }
                ],
                "resources": {
                  "limits": {
                    "cpu": "10",
                    "ephemeral-storage": "94Gi",
                    "memory": "40Gi",
                    "nvidia.com/gpu": "1"
                  },
                  "requests": {
                    "cpu": "10",
                    "ephemeral-storage": "94Gi",
                    "memory": "40Gi",
                    "nvidia.com/gpu": "1"
                  }
                },
                "volumeMounts": [
                  {
                    "mountPath": "/opt/.aws/config",
                    "name": "config-volume",
                    "subPath": "config"
                  },
                  {
                    "mountPath": "/dev/shm",
                    "name": "dshm"
                  },
                  {
                    "mountPath": "/app/user_config",
                    "name": "user-config",
                    "subPath": "raw_data"
                  },
                  {
                    "mountPath": "/app/endpoint_config",
                    "name": "endpoint-config",
                    "subPath": "raw_data"
                  }
                ]
              }
            ],
            "nodeSelector": {
              "k8s.amazonaws.com/accelerator": "nvidia-hopper-h100",
              "node-lifecycle": "normal"
            },
            "priorityClassName": "model-engine-high-priority",
            "serviceAccount": "aws-profile",
            "terminationGracePeriodSeconds": 600,
            "tolerations": [
              {
                "effect": "NoSchedule",
                "key": "nvidia.com/gpu",
                "operator": "Exists"
              }
            ],
            "volumes": [
              {
                "configMap": {
                  "name": "aws-profile-config"
                },
                "name": "config-volume"
              },
              {
                "configMap": {
                  "name": "launch-endpoint-id-end-abcdefg"
                },
                "name": "user-config"
              },
              {
                "configMap": {
                  "name": "launch-endpoint-id-end-abcdefg-endpoint-config"
                },
                "name": "endpoint-config"
              },
              {
                "emptyDir": {
                  "medium": "Memory"
                },
                "name": "dshm"
              }
            ]
          }
        }
      },
      "replicas": 0,
      "rolloutStrategy": {
        "rollingUpdateConfiguration": {
          "maxSurge": 0,
          "maxUnavailable": 1
        },
        "type": "RollingUpdate"
      },
      "startupPolicy": "LeaderCreated"
    },
    "status": {
      "conditions": [
        {
          "lastTransitionTime": "2000-01-01T01:38:14Z",
          "message": "All replicas are ready",
          "reason": "AllGroupsReady",
          "status": "True",
          "type": "Available"
        }
      ],
      "hpaPodSelector": "leaderworkerset.sigs.k8s.io/name=launch-endpoint-id-end-abcdefg,leaderworkerset.sigs.k8s.io/worker-index=0"
    }
  }